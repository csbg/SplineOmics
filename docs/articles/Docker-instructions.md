# Docker-instructions

## Pulling the `Docker` Container

To pull the Docker container, use the following command. Make sure to
check for the newest version or the specific version you need by
visiting the [Docker Hub
repository](https://hub.docker.com/r/thomasrauter/splineomics).

``` bash
docker pull thomasrauter/splineomics:latest
```

If you face ‘permission denied’ issues, check out the ‘Docker permission
denied’ vignette of SplineOmics.

## Running the `Docker` Container

To run the `Docker` container, you can use one of the following
commands, depending on your operating system. Before running the
command, ensure that you are in a directory containing two subfolders:
`input` and `output`. These will be used to transfer files between your
local machine and the Docker container.

For Linux and macOS (`Bash`):

``` bash
docker run -it -d \
    -v $(pwd)/input:/home/rstudio/input \
    -v $(pwd)/output:/home/rstudio/output \
    -p 8888:8787 \
    -e PASSWORD=123 \
    --name splineomics \
    thomasrauter/splineomics:latest
```

For Windows (`PowerShell`):

``` powershell
docker run -it -d `
    -v "${PWD}\input:/home/rstudio/input" `
    -v "${PWD}\output:/home/rstudio/output" `
    -p 8888:8787 `
    -e PASSWORD=123 `
    --name splineomics `
    thomasrauter/splineomics:latest
```

Once the container is running, open a web browser and navigate to
<http://localhost:8888>. Log in using the following credentials:

- Username: rstudio

- Password: The one you set with the -e PASSWORD=123 option (123 in this
  case)

As long as the container is running, you can work on that localhost page
with RStudio, where also the `SplineOmics` package is installed.
`/home/rstudio/` is your R session working folder.

Stop the container:

``` bash
docker stop splineomics
```

Start the container again:

``` bash
docker start splineomics
```

## Using the Docker Desktop gui instead

Instead of pasting commands into the Power- or Bashshell, you can also
do all of this with the graphical user interface of Docker Desktop. When
you do that and still want to use the link to the localhost page
provided above, set the port to 8888 (or otherwise, you have to change
the link so that it points to your port). Additionally, if you don’t set
a passwort when starting the container using the GUI, then your password
is generated randomly and is written in red in the logs of that
container.

## Input and Output File Management

The `input` and `output` directories on your local machine are mounted
to corresponding directories inside the Docker container. This allows
seamless file transfer between your local machine and the container.

- Place your input files (e.g., data, metadata, annotation files) in the
  `input` directory on your local machine. These files will
  automatically appear in `/home/rstudio/input` inside the container.

- Any files generated by RStudio within the container should be saved to
  `/home/rstudio/output`. These files will automatically appear in the
  `output` directory on your local machine.

| **Local Directory** | **Docker Container Directory** | **Description** |
|----|----|----|
|  | `/home/rstudio/` | Working directory in |
| the RStudio session inside the container. |  |  |
| `input/` | `/home/rstudio/input/` | Place your input files |
| here on your local machine. |  |  |
| `output/` | `/home/rstudio/output/` | Files generated in |
| the container will appear here locally. |  |  |

## Inspect `Docker` container installations

To see all the R packages and system installations that make up the
`Docker` container, you can run the following command in the terminal of
RStudio on your localhost browser page.

``` bash
cp -r /log home/rstudio/output
```

Because the `/home/rstudio/output` dir is mounted to your local
filesystem, this will make the installation log files available there.

## Installing additional R packages in the container

New R packages can be installed the normal way:

``` r
install.packages("package_name")
```

However, note that any packages installed in the running container will
be lost if the container is deleted or rebuilt.

## Permanent additions

If you want to permanently add R packages, R scripts, or other files to
the SplineOmics `Docker` image, you can use it as a base image for
building a new image. This will ensure that all changes are saved into
the new image, rather than being lost when the container is deleted.

For example:

``` bash
# Use the SplineOmics image as the base image
FROM thomasrauter/splineomics:latest

# Install the data.table package permanently
RUN R -e "install.packages('data.table')"

# Optionally, add custom R scripts to the image
COPY your_script.R /home/rstudio/your_script.R

# Set the working directory
WORKDIR /home/rstudio

# Expose RStudio Server port
EXPOSE 8787

# Start RStudio server
CMD ["/init"]

# Build new image:
# docker build -t your_new_image_name .
```

Run the container of the new image with the commands described above.

## Creating a Reproducible Docker Container with Automated Analysis

When you have your final analysis script inside the Docker container of
the `SplineOmics` package, and you want that other scientists can easily
reproduce your results by running just one line of code, follow the
guide below. This will instruct you how to create a new image based on
your container, which you can save for example on `Docker Hub`. Others
can download this image, and run the container to get the exact same
results you got.

### 1. Prepare your analysis and scripts

Ensure all analysis scripts and necessary files are saved in a dedicated
directory inside the container (e.g., `/home/rstudio/analysis/`). Your
analysis script should take the input files from a directory like
/home/rstudio/input/ (which is already inside the container and does not
need to be mounted again when reproducing the analysis) and output all
results to /home/rstudio/output/. The /home/rstudio/output/ directory is
mounted to a local directory on the user’s machine, making the results
accessible outside the container. Example directory structure:

``` bash
/home/rstudio/
└── analysis/
    ├── final_analysis.R   # Main analysis script
    └── helper_functions.R # Supporting scripts
```

### 2. Create an Entry Point Script

Create a bash script (run_analysis.sh) that runs your analysis
automatically.

Example run_analysis.sh:

``` bash
#!/bin/bash
Rscript /home/rstudio/analysis/final_analysis.R
tail -f /dev/null  # Keep the container running after analysis
```

Save this script in `/home/rstudio/`.

### 3. Commit the Container as a New Image with an Entry Point

Once your scripts are ready, commit the running container as a new image
and set the new entry point to run the bash script automatically:

``` bash
docker commit \
    --change='CMD ["/bin/bash", "/home/rstudio/run_analysis.sh"]' \
    <container_id> \
    thomasrauter/splineomics-analysis:v1
```

### 4. Push the New Image to `Docker Hub`

Push the new image to `Docker Hub` so others can easily pull and
reproduce the analysis:

``` bash
docker push thomasrauter/splineomics-analysis:v1
```

Others can pull (download) the container with this command:

``` bash
docker pull thomasrauter/splineomics-analysis:v1
```

### 5. Running the container to reproduce the results

To reproduce the results, you need to create a local directory where the
results will be saved and then mount this directory to the container’s
/home/rstudio/output/ directory.

Use the following command to run the container and ensure that the
results are saved to the local output directory (see commands in section
Running the `Docker` Container above how to mount the `output` dir in
the current working dir).

``` bash
docker run -it \
    -v /path/to/local/output:/home/rstudio/output \
    thomasrauter/splineomics-analysis:v1
```

### (Optional) Getting insights into the full analysis

Start a new container and mount an empty local directory to the
/home/rstudio/ directory inside the container. This allows you to
directly access all the analysis files on your local machine.

``` bash
docker run -it \
    -v /path/to/local/dir:/home/rstudio \
    thomasrauter/splineomics-analysis:v1
```

## Session Info

    ## R version 4.5.2 (2025-10-31)
    ## Platform: x86_64-pc-linux-gnu
    ## Running under: Ubuntu 22.04.5 LTS
    ## 
    ## Matrix products: default
    ## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 
    ## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0  LAPACK version 3.10.0
    ## 
    ## locale:
    ##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
    ##  [3] LC_TIME=de_AT.UTF-8        LC_COLLATE=en_US.UTF-8    
    ##  [5] LC_MONETARY=de_AT.UTF-8    LC_MESSAGES=en_US.UTF-8   
    ##  [7] LC_PAPER=de_AT.UTF-8       LC_NAME=C                 
    ##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
    ## [11] LC_MEASUREMENT=de_AT.UTF-8 LC_IDENTIFICATION=C       
    ## 
    ## time zone: Europe/Vienna
    ## tzcode source: system (glibc)
    ## 
    ## attached base packages:
    ## [1] stats     graphics  grDevices datasets  utils     methods   base     
    ## 
    ## loaded via a namespace (and not attached):
    ##  [1] desc_1.4.3          digest_0.6.39       R6_2.6.1           
    ##  [4] fastmap_1.2.0       xfun_0.56           cachem_1.1.0       
    ##  [7] knitr_1.51          htmltools_0.5.9     rmarkdown_2.30     
    ## [10] lifecycle_1.0.5     cli_3.6.5           sass_0.4.10        
    ## [13] pkgdown_2.2.0       textshaping_1.0.4   jquerylib_0.1.4    
    ## [16] renv_1.1.7          systemfonts_1.3.1   compiler_4.5.2     
    ## [19] rstudioapi_0.18.0   tools_4.5.2         ragg_1.5.0         
    ## [22] bslib_0.10.0        evaluate_1.0.5      yaml_2.3.12        
    ## [25] otel_0.2.0          BiocManager_1.30.27 jsonlite_2.0.0     
    ## [28] htmlwidgets_1.6.4   rlang_1.1.7         fs_1.6.6
