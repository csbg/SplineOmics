% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cluster_hits.R
\name{cluster_hits}
\alias{cluster_hits}
\title{cluster_hits()}
\usage{
cluster_hits(
  splineomics,
  nr_clusters,
  adj_pthresholds = c(0.05),
  adj_pthresh_avrg_diff_conditions = 0.05,
  adj_pthresh_interaction_condition_time = 0.05,
  min_effect_size = list(time_effect = 0, avg_diff_cond = 0),
  genes = NULL,
  plot_info = list(y_axis_label = "Value", time_unit = "min", treatment_labels = NA,
    treatment_timepoints = NA),
  plot_options = list(cluster_heatmap_columns = FALSE, meta_replicate_column = NULL),
  raw_data = NULL,
  report_dir = here::here(),
  report = TRUE,
  max_hit_number = 25
)
}
\arguments{
\item{splineomics}{An S3 object of class `SplineOmics` that contains all the
necessary data and parameters for the analysis, including:
\itemize{
  \item \code{data}: The original expression dataset used for differential
  expression analysis.
  \item \code{meta}: A dataframe containing metadata corresponding to the
  \code{data}, must include a 'Time' column and any columns specified by
  \code{conditions}.
  \item \code{annotation}: A dataframe that maps the rows of \code{data} to
  annotation info, such as the gene name or database identifiers.
  \item \code{report_info}: A named list describing the experiment.  
  Must include the following fields:  
    - \code{"omics_data_type"}  
    - \code{"data_description"}  
    - \code{"data_collection_date"}  
    - \code{"analyst_name"}  
    - \code{"contact_info"}  
    - \code{"project_name"}  
  
  May also include the following optional fields:  
    - \code{"method_description"}  
    - \code{"results_summary"}  
    - \code{"conclusions"}  
  \item \code{design}: A character of length 1 representing the limma
  design formula.
  \item \code{mode}: Specifies how the design formula is constructed: 
  either `"isolated"` or `"integrated"`. 
  
  - `"isolated"`: Each level is analyzed independently, using only the 
    subset of data corresponding to that level. The design formula does 
    not include the condition variable, since only one condition is 
    present in each subset.
  
  - `"integrated"`: All levels are analyzed together in a single model, 
    using the full dataset. The design formula includes the condition 
    variable (and optionally interaction terms with it) so that results 
    are estimated jointly across all levels.
  \item \code{condition}: Character vector of length 1 specifying the column
  name in \code{meta} used to define groups for analysis.
  \item \code{spline_params}: A list of spline parameters for the analysis.
  \item \code{meta_batch_column}: A character string specifying the column
  name in the metadata used for batch effect removal.
  \item \code{meta_batch2_column}: A character string specifying the second
  column name in the metadata used for batch effect removal.
  \item \code{limma_splines_result}: A list of data frames, each representing
   a top table from differential expression analysis, containing at least
   'adj.P.Val' and expression data columns.
  \item \code{feature_name_columns}: Character vector of strings that each
  specify a column of the original data dataframe which were used to 
  automatically build the feature names with the \code{extract_data}
  function.
}}

\item{nr_clusters}{A list whose length matches `top_tables`; each element is
a numeric vector of positive integers (e.g. `1:1`, `2:8`) giving the
candidate number(s) of clusters for the corresponding condition level.}

\item{adj_pthresholds}{Numeric vector of p-value thresholds for filtering
hits in each top table.}

\item{adj_pthresh_avrg_diff_conditions}{p-value threshold for the results
from the average difference of the condition limma result. Per default 0 (
turned off).}

\item{adj_pthresh_interaction_condition_time}{p-value threshold for the
results from the interaction of condition and time limma result. Per default
0 (turned off).}

\item{min_effect_size}{A named list that specifies the minimum effect size
  thresholds to consider a feature as biologically meaningful, in addition
  to statistical significance. This allows users to filter out "trivial"
  hits that pass adjusted p-value cutoffs but show negligible effect sizes.

  The list must contain the following elements:
  - `time_effect`: Minimum absolute effect size (e.g., log-fold change or
    model coefficient) for time effects. Features with a smaller effect size
    will be ignored even if they are statistically significant.
  - `avg_diff_cond`: Minimum absolute effect size for average differences
    between conditions. As above, this ensures that only condition
    contrasts with biologically relevant magnitude are reported.

  Values should be numeric (typically >0). For example,
  `min_effect_size = list(time_effect = 1, avg_diff_cond = 1)` will only
  keep time effects and condition differences with an absolute effect size
  of at least 1 unit. Use smaller values (e.g., 0.1) for more permissive
  filtering, or larger values to be more conservative.
  
  The default is the value 0 for both `time_effect` and `avg_diff_cond`.}

\item{genes}{A character vector containing the gene names of the features to
be analyzed. The entries should be in the same order as they appear in data.}

\item{plot_info}{List containing the elements y_axis_label (string),
time_unit (string), treatment_labels (character vector),
treatment_timepoints (integer vector). All can also be NA.
This list is used to add this info to the spline plots.
time_unit is used to label the x-axis, and treatment_labels
and -timepoints are used to create vertical dashed lines,
indicating the positions of the treatments (such as
feeding, temperature shift, etc.).}

\item{plot_options}{List with specific fields (cluster_heatmap_columns =
Bool) that allow for customization of plotting behavior.}

\item{raw_data}{Optional. Data matrix with the raw (unimputed) data, still 
containing NA values. When provided, it highlights the datapoints in the 
spline plots that originally where NA and that were imputed.}

\item{report_dir}{Character string specifying the directory path where the
HTML report and any other output files should be saved.}

\item{report}{Boolean TRUE or FALSE value specifing if a report should be
generated.}

\item{max_hit_number}{Maximum number of hits which are plotted within each
cluster. This can be used to limit the computation time and size of
the HTML report in the case of many hits. Default is 100.}
}
\value{
A named list with two elements:
\describe{
  \item{\code{cluster_summary}}{
    A tibble containing one row per \code{feature_nr} with metadata and
    cluster assignments across the analysis categories. The structure is:
    \itemize{
      \item \code{feature_nr} – Numeric feature identifier.
      \item \code{feature_name} – Preferred feature name, prioritizing
        values from the limma tables, then from the cluster table row
        names, and falling back to the numeric feature ID.
      \item \code{gene} – Preferred gene symbol from the \code{annotation}
        table if available, otherwise taken from the cluster tables.
      \item \code{cluster_<cond1>} / \code{cluster_<cond2>} – Cluster
        assignments for each time-effect condition, named according to
        the elements of \code{clustered_hits_levels}.
      \item \code{cluster_cat2} – Present only if category 2 results are
        available; a combined cluster label in the form
        \code{"<cluster_<cond1>>_<cluster_<cond2>>"} for features that
        are significant in category 2. If this value is \code{NA}, the
        feature was not a category 2 hit.
      \item \code{cluster_cat3} – Present only if category 3 results are
        available; a combined cluster label in the form
        \code{"<cluster_<cond1>>_<cluster_<cond2>>"} for features that
        are significant in category 3. If this value is \code{NA}, the
        feature was not a category 3 hit.
    }
    For any category-specific cluster column (\code{cluster_<cond1>},
    \code{cluster_<cond2>}, \code{cluster_cat2}, \code{cluster_cat3}),
    a value of \code{NA} indicates that the feature was not significant
    (not a hit) in that category.
  }
  \item{\code{plots}}{
    A list of all plots generated during the run, corresponding to the
    visualizations shown in the HTML report produced by this function.
  }
}
}
\description{
Performs clustering on hits from top tables generated by differential
expression analysis.
This function filters hits based on adjusted p-value thresholds, extracts
spline coefficients for
significant features, normalizes these coefficients, and applies hierarchical
clustering. The results,
including clustering assignments and normalized spline curves, are saved in a
specified directory and
compiled into an HTML report.
}
