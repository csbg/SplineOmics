# Use the rocker RStudio image
FROM rocker/rstudio:4.3.3

# Create directories for the R package, data, output, and workspace
RUN mkdir -p /input /output /app /log /install

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    libxml2-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy the renv lockfile into the container
COPY renv.lock /usr/local/renv/renv.lock

# Install renv and restore the environment
RUN R -e 'install.packages("renv"); renv::consent(provided = TRUE); renv::init(); renv::restore()'

# Add Bioconductor's repositories and install Bioconductor packages
RUN R -e 'install.packages("BiocManager"); BiocManager::install(version = "3.18")'
RUN R -e 'BiocManager::install(c("limma", "ComplexHeatmap", "clusterProfiler"))'

# Copy the local package tarball into the Docker image
COPY ./git_ignore/SplineOmics_0.1.0.tar.gz /tmp/SplineOmics_0.1.0.tar.gz

# Install the package from the tarball, including dependencies
RUN R -e "remotes::install_local('/tmp/SplineOmics_0.1.0.tar.gz', dependencies = TRUE)" 2>&1 | tee /log/install_log.txt

# Write installed R packages and versions to a file
RUN R -e "installed_packages <- installed.packages(); write.csv(installed_packages, '/log/installed_r_packages.csv', row.names = FALSE)"

# Write installed operating system packages to a file
RUN dpkg-query -Wf '${Package} ${Version}\n' > /log/installed_os_packages.txt

# Set the working directory for subsequent instructions
WORKDIR /app

# Default command
CMD ["rstudio-server", "start"]

